<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <title>Luncheon Map</title>
        <style>
            * {
                font-size: 1em;
                box-sizing: border-box;
                -moz-box-sizing: border-box;
            }
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            body {
                font-size: 81.25%;
                font-family: 'Meiryo UI',sans-serif;
            }
            table {
                border-collapse: collapse;
            }
            .button {
                cursor: pointer;
                white-space: nowrap;
                border-radius: 5px;
                padding: .2em .6em;
                text-shadow: 1px 1px 1px #999999;
                color: #333333;
                background-color: #f0f0f0;
                border: 1px solid #666666;
            }
            .tabbar td {
                vertical-align: middle;
                text-align: center;
                height: 32px;
                border: 1px solid white;
                border-bottom-width: 0;
                background: #434343;
            }
            .tabbar td:first-child {
                border-left-width: 0;
            }
            .tab {
                cursor: pointer;
                font-size: 11px;
                color: white;
            }
            .watch-position-button {
                cursor: pointer;
                width: 24px;
                height: 24px;
                margin: 0 4px;
                background: #f0f0f0;  /* todo: アイコン */
                border-radius: 5px;
                border: groove 1px;
            }
            .watch-position-button.active {
                background: #ccccff;
                border: ridge 1px;
            }
            .hidden-container {
                display: none;
                position: absolute;
                left: 0;
                right: 0;
                color: white;
                background: rgba(32, 32, 32, .6);
            }

            #map-container .balloon-name {
                display: inline-block;
                font-size: 1.2em;
            }
            #map-container .balloon-icon-favorite {
                display: inline-block;
                margin-left: .5em;
                font-size: 1.2em;
                color: #FFCC00;
            }
            #map-container .button {
                font-weight: bold;
            }
        </style>

        <!-- Places API [ https://developers.google.com/maps/documentation/javascript/places?hl=ja ] -->
        <script charset="utf-8" src="//maps.googleapis.com/maps/api/js?v=3&region=JP&libraries=places&sensor=false"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script>
            var objects = {
                hasProperties: function (obj, properties) {
                    for (var key in properties) {
                        if (obj[key] !== properties[key]) {
                            return false;
                        }
                    }
                    return true;
                }
            };

            var arrays = {
                observe: function (array, callback) {
                    ['push', 'pop', 'shift', 'unshift', 'splice', 'reverse', 'sort'].forEach(function (method) {
                        array[method] = Array.prototype[method] && function () {
                            var before = this.slice(0);
                            Array.prototype[method].apply(this, arguments);
                            var after = this.slice(0);
                            callback.call(this, before, after);
                        };
                    });
                    return array;
                },
                removeIf: function (array, predicate) {
                    for (var i = array.length - 1; i >= 0; i--) {
                        if (predicate(array[i])) {
                            array.splice(i, 1);
                        }
                    }
                },
                removeWhere: function (array, properties) {
                    this.removeIf(array, function (item) {
                        return objects.hasProperties(array[i], properties);
                    });
                },
                findWhere: function (array, properties) {
                    for (var i = 0; i < array.length; i++) {
                        if (objects.hasProperties(array[i], properties)) {
                            return array[i];
                        }
                    }
                }
            };

            var createStoredArray = function (key) {
                var array = arrays.observe([], function () {
                    localStorage.setItem(key, JSON.stringify(this));
                });
                array.restore = function () {
                    var jsonRestored = localStorage.getItem(key);
                    var restored = jsonRestored && JSON.parse(jsonRestored);
                    restored && restored.forEach(function (record) {
                        record && Array.prototype.push.call(this, record);
                    }, this);
                    return this;
                };
                return array;
            };
        </script>
    </head>
    <body>
        <table style="width: 100%; height: 100%;">
            <tr>
                <td colspan="6" style="height: 100%;"><div id="map-container" style="height: 100%;"></div></td>
            </tr>
            <tr class="tabbar">
                <td><div class="watch-position-button" onclick="if(positionWatcher.watchId){$(this).removeClass('active');positionWatcher.stop();}else{$(this).addClass('active');positionWatcher.start();}">p</div></td>
                <td width="25%" class="tab" onclick="$('#keyword-search-container').slideToggle().find('input').focus();">検索</td>
                <td width="25%" class="tab" onclick="displayFavorites()">お気に入り</td>
                <!-- <td width="25%" class="tab" onclick="displayHistories()">履歴</td> -->
                <td width="25%" class="tab" id="random-choice-button">自動選択</td>
                <td width="25%" class="tab" onclick="placeMarkers.splice(0,placeMarkers.length)">クリア</td>
            </tr>
        </table>

        <!-- キーワード検索 -->
        <form class="hidden-container" id="keyword-search-container" style="top: 0;" onsubmit="if(this.keyword.value){$(':focus').blur();$(this).slideUp();search(this.keyword.value,500);}return false;">
            <table style="width: 100%;">
                <tr>
                    <td><input type="text" name="keyword" style="width: 100%;"></td>
                    <td style="width: 1px;"><div class="button" onclick="$('#keyword-search-container').slideUp()">キャンセル</div></td>
                </tr>
            </table>
        </form>

        <div id="loading-indicator" style="display: none; position: absolute; top: 0; bottom: 0; left: 0; right: 0; padding: 2%; background: transparent;">
            <table style="width: 100%; height: 100%;">
                <tr>
                    <td style="text-align: center; vertical-align: middle; border-radius: 8px; background: rgba(64,64,64,.6); color: white;">loading...</td>
                </tr>
            </table>
        </div>

        <script>
            var loading = {
                start: $.proxy($.fn.fadeIn, $('#loading-indicator')),
                end: $.proxy($.fn.fadeOut, $('#loading-indicator'))
            };

            var favorites = createStoredArray('luncheon.map.favorites').restore();
            console.log('restored favorites: ', favorites);

            var histories = createStoredArray('luncheon.map.histories');
            var appendHistory = function (div) {
                var placeMarker = arrays.findWhere(placeMarkers, {id: div.getAttribute('data-place-id')});
                console.log('append history: ', placeMarker);
                histories.push(placeMarker.place);
            };

            var PlaceMarker = function (map, place, balloon) {
                var self = this;
                if (place.geometry && place.geometry.location && place.geometry.location.lat) {
                    place.latitude = place.geometry.location.lat();
                    place.longitude = place.geometry.location.lng();
                } else {
                    place.geometry = { location: new google.maps.LatLng(place.latitude, place.longitude) };
                }
                this.id = place.id;
                this.place = place;
                this.balloon = balloon;
                this.marker = new google.maps.Marker({
                    map: map,
                    position: place.geometry.location,
                    title: place.name,
                    animation: google.maps.Animation.DROP
                });
                this.setMap = function (map) { this.marker.setMap(map); };
                this.openBalloon = function () {
                    if (this.balloon) {
                        this.balloon.setContent(
                            '<div class="balloon-name">' + this.place.name + '</div>' +
                            '<div class="balloon-vicinity">' + this.place.vicinity + '</div>' +
                            // '<div class="button" data-place-id="' + this.place.id + '" onclick="appendHistory(this)" style="display: inline-block;">ここへ行く</div>'
                            '<div class="balloon-icon-favorite" data-place-id="' + this.place.id + '" onclick="toggleFavorite(this)">' + (arrays.findWhere(favorites, {id: this.place.id}) ? '★' : '☆') + '</div>' +
                            ''
                        );
                        this.balloon.open(this.marker.getMap(), this.marker);
                    }
                };
                this.bounce = function (timeout) {
                    this.marker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(function () { self.marker.setAnimation(null); }, timeout);
                };
                google.maps.event.addListener(this.marker, 'click', function () { self.openBalloon(); });
            };

            var map = new google.maps.Map(document.getElementById('map-container'), {
                center: new google.maps.LatLng(
                    localStorage.getItem('luncheon.map.center.latitude') || 35.64574098673823,
                    localStorage.getItem('luncheon.map.center.longitude') || 139.74516057968137
                ),
                zoom: parseInt(localStorage.getItem('luncheon.map.zoom')) || 16,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                streetViewControl: false
            });
            google.maps.event.addListener(map, 'center_changed', function() {
                localStorage.setItem('luncheon.map.center.latitude', map.getCenter().lat());
                localStorage.setItem('luncheon.map.center.longitude', map.getCenter().lng());
            });
            google.maps.event.addListener(map, 'zoom_changed', function() {
                localStorage.setItem('luncheon.map.zoom', map.getZoom());
            });

            var balloon = new google.maps.InfoWindow();
            var placeMarkers = arrays.observe([], function (before, after) {
                if (before.length > after.length) {
                    before.filter(function (item) {
                        return after.indexOf(item) === -1;
                    }).forEach(function (placeMarker) {
                        placeMarker.setMap(null);
                    });
                }
            });
            var placesService = new google.maps.places.PlacesService(map);
            var search = function (keyword, radius) {
                loading.start();
                placesService.search({ bounds: map.getBounds(), keyword: keyword }, function (places, status) {
                    loading.end();
                    console.log('places:', arguments);
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        places.forEach(function (place) { placeMarkers.push(new PlaceMarker(map, place, balloon)); });
                    }
                });
            };

            var displayFavorites = function () {
                favorites.forEach(function (place) { placeMarkers.push(new PlaceMarker(map, place, balloon)); });
            };
            var displayHistories = function () {
                histories.restore();
                histories.forEach(function (place) { placeMarkers.push(new PlaceMarker(map, place, balloon)); });
            };
            displayFavorites();

            // 現在地取得
            var positionWatcher = {
                watchId: null,
                start: function () {
                    this.watchId = this.watchId || navigator.geolocation.watchPosition(
                        function (position) {
                            map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
                        },
                        function (error) {
                            console.log(error);
                            alert('位置情報を取得できませんでした。\nMessage: ' + error.message);
                        }
                    );
                },
                stop: function () {
                    this.watchId && navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                },
            };

            // ランダム選択
            document.getElementById('random-choice-button').addEventListener('click', function () {
                // 画面外のマーカー削除
                arrays.removeIf(placeMarkers, function (placeMarker) {
                    return !map.getBounds().contains(placeMarker.marker.position);
                });
                // ランダム順にマーカー削除
                var timeoutInMilliseconds = 1200 / placeMarkers.length;
                var onTimeout = function () {
                    if (placeMarkers.length === 1) {
                        placeMarkers[0].bounce(2130);
                        placeMarkers[0].openBalloon();
                    } else if (placeMarkers.length > 1) {
                        placeMarkers.splice(Math.floor(Math.random() * placeMarkers.length), 1);
                        setTimeout(onTimeout, timeoutInMilliseconds);
                    }
                };
                onTimeout();
            }, false);

            var toggleFavorite = function (div) {
                var placeMarker = arrays.findWhere(placeMarkers, {id: div.getAttribute('data-place-id')});
                if (arrays.findWhere(favorites, {id: placeMarker.place.id})) {
                    if (confirm('お気に入りから削除しますか？')) {
                        console.log('remove favorite: ', placeMarker);
                        arrays.removeWhere(favorites, {id: placeMarker.place.id});
                        div.textContent = '☆';
                    }
                } else {
                    console.log('append favorite: ', placeMarker);
                    favorites.push(placeMarker.place);
                    div.textContent = '★';
                }
            };
        </script>
    </body>
</html>
